<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Futures Volatility (Top 100)</title>
    
    <!-- 1. Preconnect: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://api.coingecko.com">
    <link rel="preconnect" href="https://fapi.binance.com">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Optimization: Minify ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ */
        body{font-family:'Sarabun',sans-serif;background-color:#f4f6f9;padding:20px}
        .container{max-width:1200px;background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
        .symbol-badge{background-color:#e9ecef;color:#495057;padding:2px 6px;border-radius:4px;font-size:.85em;font-weight:700;margin-left:5px}
        .text-green{color:#198754;font-weight:700}
        .text-red{color:#dc3545;font-weight:700}
        .coin-name-th{font-size:1.1em;font-weight:700;color:#000}
        .coin-name-en{font-size:.85em;color:#6c757d}
        /* Skeleton Loading Animation */
        .skeleton {background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite;}
        @keyframes loading {0% {background-position: 200% 0;} 100% {background-position: -200% 0;}}
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2>üöÄ 100 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç Futures ‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô (‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢)</h2>
        <div>
            <span id="lastUpdate" class="text-muted small me-2"></span>
            <button onclick="fetchData()" class="btn btn-primary" id="refreshBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>
    
    <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

    <!-- Loading State ‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏Å‡∏ß‡πà‡∏≤ Spinner -->
    <div id="loading" class="text-center my-4">
        <div class="spinner-border text-primary" role="status"></div>
        <div id="statusText" class="mt-2 text-primary fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered d-none" id="cryptoTable">
            <thead class="table-dark text-center">
                <tr>
                    <th style="width: 30%;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (TH/EN)</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤ (USD)</th>
                    <th>1 ‡∏ä‡∏°. %</th>
                    <th>24 ‡∏ä‡∏°. %</th>
                    <th>7 ‡∏ß‡∏±‡∏ô % (‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô)</th>
                    <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î (USD)</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="config.js"></script> 

<script>
    // --- Performance Utilities ---
    const CACHE_KEY_DICT = 'crypto_thai_dict_v1';
    
    // Helper Format
    const fmt = (num) => num ? num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
    const fmtPct = (num) => {
        if (num === null || num === undefined) return '-';
        return `<span class="${num >= 0 ? 'text-green' : 'text-red'}">${num.toFixed(2)}%</span>`;
    };

    // Load Cached Dictionary (‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö)
    let localDict = {};
    try {
        const saved = localStorage.getItem(CACHE_KEY_DICT);
        if (saved) localDict = JSON.parse(saved);
    } catch(e) { console.error("Cache Error", e); }

    function getThaiName(name, symbol) {
        // 1. Check Manual Config
        if (typeof manualDict !== 'undefined') {
            if (manualDict[name]) return manualDict[name];
            if (manualDict[symbol]) return manualDict[symbol];
        }
        // 2. Check LocalStorage Cache
        if (localDict[name]) return localDict[name];
        return null;
    }

    async function translateWithGeminiBatch(names) {
        if (!names.length) return {};
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ API Key ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà Error)
        if (typeof GOOGLE_API_KEY === 'undefined' || !GOOGLE_API_KEY) {
            console.warn("No Gemini API Key found.");
            return {};
        }

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GOOGLE_API_KEY}`;
        // Prompt ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î Token ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
        const prompt = `Translate to Thai (JSON format {"EnglishName":"ThaiName"}): ${names.join(", ")}`;

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { response_mime_type: "application/json" }
                })
            });
            
            const data = await response.json();
            if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                return JSON.parse(data.candidates[0].content.parts[0].text);
            }
        } catch (error) {
            console.error("AI Translation Failed:", error);
        }
        return {};
    }

    async function fetchData() {
        const loadingDiv = document.getElementById('loading');
        const statusText = document.getElementById('statusText');
        const table = document.getElementById('cryptoTable');
        const tbody = document.getElementById('tableBody');
        const alertBox = document.getElementById('alertBox');
        const refreshBtn = document.getElementById('refreshBtn');

        // UI Reset
        refreshBtn.disabled = true;
        loadingDiv.style.display = 'block';
        table.classList.add('d-none');
        alertBox.classList.add('d-none');
        tbody.innerHTML = '';
        statusText.innerText = "‚ö° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏•‡∏≤‡∏î (Parallel Fetch)...";

        try {
            // --- Optimization 1: Parallel Fetching ---
            // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ Binance ‡πÅ‡∏•‡∏∞ CoinGecko ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ï‡πà‡∏≠‡∏Ñ‡∏¥‡∏ß
            const [binanceData, cgData] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r => r.json()),
                fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=false&price_change_percentage=1h,24h,7d').then(r => r.json())
            ]);

            // Process Data
            const futuresSymbols = new Set(
                binanceData.symbols
                    .filter(s => s.status === 'TRADING' && s.quoteAsset === 'USDT')
                    .map(s => s.baseAsset.toUpperCase())
            );

            let filteredData = cgData.filter(coin => futuresSymbols.has(coin.symbol.toUpperCase()));
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô (Sort Logic)
            filteredData.forEach(coin => coin.abs_7d = Math.abs(coin.price_change_percentage_7d_in_currency || 0));
            filteredData.sort((a, b) => b.abs_7d - a.abs_7d);
            
            const top100 = filteredData.slice(0, 100);

            // --- Optimization 2: Smart Translation ---
            statusText.innerText = "ü§ñ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢...";
            
            // ‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Cache ‡πÅ‡∏•‡∏∞ Manual Dict
            const namesToTranslate = top100
                .map(c => c.name)
                .filter(name => !getThaiName(name, "")); // ‡∏™‡πà‡∏á Symbol ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠

            if (namesToTranslate.length > 0) {
                statusText.innerText = `üß† ‡πÉ‡∏´‡πâ AI ‡πÅ‡∏õ‡∏•‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà ${namesToTranslate.length} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç...`;
                const newTranslations = await translateWithGeminiBatch(namesToTranslate);
                
                // Save to Cache (Update LocalStorage)
                if (Object.keys(newTranslations).length > 0) {
                    localDict = { ...localDict, ...newTranslations };
                    localStorage.setItem(CACHE_KEY_DICT, JSON.stringify(localDict));
                }
            }

            // --- Optimization 3: DOM Fragment (Render ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ---
            const fragment = document.createDocumentFragment();
            
            top100.forEach(coin => {
                const thaiName = getThaiName(coin.name, coin.symbol) || coin.name;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-start align-middle">
                        <div class="d-flex align-items-center">
                            <img src="${coin.image}" width="24" height="24" class="me-2 rounded-circle" loading="lazy" alt="">
                            <div>
                                <div class="coin-name-th">${thaiName}</div>
                                <div class="coin-name-en">
                                    ${coin.name} 
                                    <span class="symbol-badge">${coin.symbol.toUpperCase()}</span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="text-end align-middle">${fmt(coin.current_price)}</td>
                    <td class="text-end align-middle">${fmtPct(coin.price_change_percentage_1h_in_currency)}</td>
                    <td class="text-end align-middle">${fmtPct(coin.price_change_percentage_24h_in_currency)}</td>
                    <td class="text-end align-middle">${fmtPct(coin.price_change_percentage_7d_in_currency)}</td>
                    <td class="text-end align-middle">${fmt(coin.market_cap)}</td>
                `;
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment); // Insert into DOM once
            
            // Update UI
            document.getElementById('lastUpdate').innerText = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${new Date().toLocaleTimeString('th-TH')}`;
            loadingDiv.style.display = 'none';
            table.classList.remove('d-none');

        } catch (error) {
            console.error(error);
            loadingDiv.style.display = 'none';
            alertBox.classList.remove('d-none');
            alertBox.innerHTML = `<strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong> ${error.message} <br><small>‡∏´‡∏≤‡∏Å‡∏ï‡∏¥‡∏î Rate Limit ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÉ‡∏´‡∏°‡πà</small>`;
        } finally {
            refreshBtn.disabled = false;
        }
    }

    // Auto load on start
    fetchData();
</script>

</body>
</html>