<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Futures Volatility (Graph 7D)</title>
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://api.coingecko.com">
    <link rel="preconnect" href="https://fapi.binance.com">

    <!-- Bootstrap & Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 1200px; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .symbol-badge { background-color: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 4px; font-size: .85em; font-weight: 700; margin-left: 5px; }
        
        /* Colors */
        .text-green { color: #198754; font-weight: 700; }
        .text-red { color: #dc3545; font-weight: 700; }
        
        /* Text Styles */
        .coin-name-th { font-size: 1.1em; font-weight: 700; color: #000; }
        .coin-name-en { font-size: .85em; color: #6c757d; }
        
        /* Table Alignments */
        .table td { vertical-align: middle; }
        
        /* SVG Graph Styling */
        .sparkline-container { width: 140px; height: 50px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2>üöÄ 100 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç Futures ‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô + ‡∏Å‡∏£‡∏≤‡∏ü 7 ‡∏ß‡∏±‡∏ô</h2>
        <div>
            <span id="lastUpdate" class="text-muted small me-2"></span>
            <button onclick="fetchData()" class="btn btn-primary" id="refreshBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>
    
    <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

    <!-- Loading State -->
    <div id="loading" class="text-center my-4">
        <div class="spinner-border text-primary" role="status"></div>
        <div id="statusText" class="mt-2 text-primary fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered d-none" id="cryptoTable">
            <thead class="table-dark text-center">
                <tr>
                    <th style="width: 25%;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (TH/EN)</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤ (USD)</th>
                    <th>1 ‡∏ä‡∏°. %</th>
                    <th>24 ‡∏ä‡∏°. %</th>
                    <th>7 ‡∏ß‡∏±‡∏ô %</th>
                    <th style="width: 160px;">‡∏Å‡∏£‡∏≤‡∏ü 7 ‡∏ß‡∏±‡∏ô</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- ‡πÇ‡∏´‡∏•‡∏î Config ‡∏ó‡∏µ‡πà‡∏°‡∏µ GOOGLE_API_KEY ‡πÅ‡∏•‡∏∞ manualDict -->
<script src="config.js"></script>

<script>
    const CACHE_KEY_DICT = 'crypto_thai_dict_v2';

    // Helper: Format Number
    const fmt = (num) => num ? num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
    
    // Helper: Percent Color
    const fmtPct = (num) => {
        if (num === null || num === undefined) return '-';
        return `<span class="${num >= 0 ? 'text-green' : 'text-red'}">${num.toFixed(2)}%</span>`;
    };

    // --- Helper: Create Sparkline SVG (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü) ---
    function createSparkline(data, width = 135, height = 45) {
        if (!data || data.length === 0) return '<span class="text-muted small">No Data</span>';

        const min = Math.min(...data);
        const max = Math.max(...data);
        const range = max - min;
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ: ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ = ‡πÅ‡∏î‡∏á
        const isUp = data[data.length - 1] >= data[0];
        const color = isUp ? '#198754' : '#dc3545'; 

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô Path (SVG Path Command)
        const stepX = width / (data.length - 1);
        const stepY = range === 0 ? 1 : (height - 6) / range; // -6 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏•‡πà‡∏≤‡∏á

        let pathD = `M 0 ${height - ((data[0] - min) * stepY) - 3}`;
        
        for (let i = 1; i < data.length; i++) {
            const x = i * stepX;
            const y = height - ((data[i] - min) * stepY) - 3;
            pathD += ` L ${x.toFixed(1)} ${y.toFixed(1)}`;
        }

        return `
            <div class="sparkline-container">
                <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="${pathD}" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>
            </div>
        `;
    }

    // Load Cache
    let localDict = {};
    try {
        const saved = localStorage.getItem(CACHE_KEY_DICT);
        if (saved) localDict = JSON.parse(saved);
    } catch(e) { console.error("Cache Error", e); }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö config.js)
    function getThaiName(name, symbol) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å manualDict ‡πÉ‡∏ô config.js ‡∏Å‡πà‡∏≠‡∏ô
        if (typeof manualDict !== 'undefined') {
            if (manualDict[name]) return manualDict[name];
            if (manualDict[symbol]) return manualDict[symbol];
        }
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å Cache
        if (localDict[name]) return localDict[name];
        return null;
    }

    // AI Translation Function
    async function translateWithGeminiBatch(names) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GOOGLE_API_KEY ‡∏à‡∏≤‡∏Å config.js
        if (typeof GOOGLE_API_KEY === 'undefined' || !GOOGLE_API_KEY) {
            console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö GOOGLE_API_KEY ‡πÉ‡∏ô config.js");
            return {};
        }
        
        if (!names.length) return {};
        
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GOOGLE_API_KEY}`;
        const prompt = `Translate to Thai (JSON format {"EnglishName":"ThaiName"}): ${names.join(", ")}`;

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { response_mime_type: "application/json" }
                })
            });
            
            const data = await response.json();
            if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                return JSON.parse(data.candidates[0].content.parts[0].text);
            }
        } catch (error) {
            console.error("AI Translation Failed:", error);
        }
        return {};
    }

    async function fetchData() {
        const loadingDiv = document.getElementById('loading');
        const statusText = document.getElementById('statusText');
        const table = document.getElementById('cryptoTable');
        const tbody = document.getElementById('tableBody');
        const alertBox = document.getElementById('alertBox');
        const refreshBtn = document.getElementById('refreshBtn');

        refreshBtn.disabled = true;
        loadingDiv.style.display = 'block';
        table.classList.add('d-none');
        alertBox.classList.add('d-none');
        tbody.innerHTML = '';
        statusText.innerText = "‚ö° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏Ñ‡∏≤ (Parallel Fetch)...";

        try {
            // 1. Fetch Binance & CoinGecko (‡πÄ‡∏û‡∏¥‡πà‡∏° sparkline=true)
            const [binanceData, cgData] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r => r.json()),
                fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=true&price_change_percentage=1h,24h,7d').then(r => r.json())
            ]);

            // 2. Filter Futures Symbols
            const futuresSymbols = new Set(
                binanceData.symbols
                    .filter(s => s.status === 'TRADING' && s.quoteAsset === 'USDT')
                    .map(s => s.baseAsset.toUpperCase())
            );

            let filteredData = cgData.filter(coin => futuresSymbols.has(coin.symbol.toUpperCase()));
            
            // 3. Sort by Volatility (7D)
            filteredData.forEach(coin => coin.abs_7d = Math.abs(coin.price_change_percentage_7d_in_currency || 0));
            filteredData.sort((a, b) => b.abs_7d - a.abs_7d);
            
            const top100 = filteredData.slice(0, 100);

            // 4. Translate Names
            statusText.innerText = "ü§ñ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢...";
            const namesToTranslate = top100
                .map(c => c.name)
                .filter(name => !getThaiName(name, ""));

            if (namesToTranslate.length > 0) {
                statusText.innerText = `üß† ‡πÉ‡∏´‡πâ AI ‡πÅ‡∏õ‡∏•‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà ${namesToTranslate.length} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç...`;
                const newTranslations = await translateWithGeminiBatch(namesToTranslate);
                if (Object.keys(newTranslations).length > 0) {
                    localDict = { ...localDict, ...newTranslations };
                    localStorage.setItem(CACHE_KEY_DICT, JSON.stringify(localDict));
                }
            }

            // 5. Render Table
            const fragment = document.createDocumentFragment();
            
            top100.forEach(coin => {
                const thaiName = getThaiName(coin.name, coin.symbol) || coin.name;
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü SVG ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sparkline
                const graphHtml = createSparkline(coin.sparkline_in_7d?.price);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-start">
                        <div class="d-flex align-items-center">
                            <img src="${coin.image}" width="24" height="24" class="me-2 rounded-circle" loading="lazy" alt="">
                            <div>
                                <div class="coin-name-th">${thaiName}</div>
                                <div class="coin-name-en">
                                    ${coin.name} 
                                    <span class="symbol-badge">${coin.symbol.toUpperCase()}</span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="text-end">${fmt(coin.current_price)}</td>
                    <td class="text-end">${fmtPct(coin.price_change_percentage_1h_in_currency)}</td>
                    <td class="text-end">${fmtPct(coin.price_change_percentage_24h_in_currency)}</td>
                    <td class="text-end">${fmtPct(coin.price_change_percentage_7d_in_currency)}</td>
                    <td class="text-center p-1">${graphHtml}</td>
                `;
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);
            document.getElementById('lastUpdate').innerText = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${new Date().toLocaleTimeString('th-TH')}`;
            loadingDiv.style.display = 'none';
            table.classList.remove('d-none');

        } catch (error) {
            console.error(error);
            loadingDiv.style.display = 'none';
            alertBox.classList.remove('d-none');
            alertBox.innerHTML = `<strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong> ${error.message} <br><small>‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î‡∏•‡∏¥‡∏°‡∏¥‡∏ï API ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÉ‡∏´‡∏°‡πà</small>`;
        } finally {
            refreshBtn.disabled = false;
        }
    }

    // Auto load
    fetchData();
</script>

</body>
</html>